@model IEnumerable<Employee_Management_System.Models.EmployeeModel>;

@{
    ViewData["title"] = "Employee Details";
}

<!-- Button trigger modal for Save Data -->
<button type="button" class="btn btn-primary my-2" data-bs-toggle="modal" data-bs-target="#saveEmployeeModal">Add New Employee</button>

<!-- Modal for Save Data -->
<div class="modal fade" id="saveEmployeeModal" tabindex="-1" aria-labelledby="saveEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveEmployeeModalLabel">Add New Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form autocomplete="off">

                <input id="empId" name="Id" type="number" class="form-control" hidden>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <label for="firstName" class="form-label">First Name</label>
                            <input id="firstName" name="FirstName" type="text" class="form-control">
                        </div>
                        <div class="col-6">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input id="lastName" name="LastName" type="text" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <label for="emailId" class="form-label">Email</label>
                            <input id="emailId" name="EmailId" type="text" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-8">
                            <label for="contactNo" class="form-label">Contact No.</label>
                            <input id="contactNo" name="ContactNo" type="text" class="form-control">
                        </div>
                        <div class="col-4">
                            <label for="age" class="form-label">Age</label>
                            <input id="age" name="Age" type="text" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-8">
                            <label for="imageFile" class="form-label">Profile Image</label>
                            <input id="imageFile" name="imageFile" type="file" class="form-control">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="changeBtn" onclick="saveEmployee()">Save changes</button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Modal for Update Data -->
<div class="modal fade" id="updateEmployeeModal" tabindex="-1" aria-labelledby="updateEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateEmployeeModalLabel">Update Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="updateForm" autocomplete="off">

                <div class="modal-body">

                    <input id="empId_u" name="Id" type="number" class="form-control" hidden>

                    <div class="row">
                        <div class="col-6">
                            <label for="firstName_u" class="form-label">First Name</label>
                            <input id="firstName_u" name="FirstName" type="text" class="form-control">
                        </div>
                        <div class="col-6">
                            <label for="lastName_u" class="form-label">Last Name</label>
                            <input id="lastName_u" name="LastName" type="text" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <label for="emailId_u" class="form-label">Email</label>
                            <input id="emailId_u" name="EmailId" type="text" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-8">
                            <label for="contactNo_u" class="form-label">Contact No.</label>
                            <input id="contactNo_u" name="ContactNo" type="text" class="form-control">
                        </div>
                        <div class="col-4">
                            <label for="age_u" class="form-label">Age</label>
                            <input id="age_u" name="Age" type="text" class="form-control">
                        </div>
                    </div>

                    @* <div class="row">
                        <div class="col-12">
                            <label for="imageFile_u" class="form-label">Profile Image</label>
                            <input id="imageFile_u" name="imageFile" type="file" class="form-control">
                        </div>
                    </div> *@

                    <div class="row">
                        <div class="col-12">
                            <label for="imageFile_u" class="form-label">Profile Image</label>
                            <input id="imageFile_u" name="imageFile" type="file" class="form-control" onchange="previewImage(this)">
                            <!-- Image preview -->
                            <img id="imagePreview_u" src="#" alt="Image Preview" style="max-width: 100%; max-height: 150px; margin-top: 10px; display: none;">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="updateEmployee()">Update changes</button>
                </div>

            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="viewEmployeeModal" tabindex="-1" aria-labelledby="viewEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEmployeeModalLabel">Employee Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form>
                <div class="modal-body">

                    <div class="row">
                        <div class="col-12">
                            <label for="empId_r" class="form-label">Employee Id</label>
                            <input id="empId_r" name="Id" type="number" class="form-control" readonly>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <label for="firstName_r" class="form-label">First Name</label>
                            <input id="firstName_r" name="FirstName" type="text" class="form-control" readonly>
                        </div>
                        <div class="col-6">
                            <label for="lastName_r" class="form-label">Last Name</label>
                            <input id="lastName_r" name="LastName" type="text" class="form-control" readonly>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <label for="emailId_r" class="form-label">Email</label>
                            <input id="emailId_r" name="EmailId" type="text" class="form-control" readonly>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-8">
                            <label for="contactNo_r" class="form-label">Contact No.</label>
                            <input id="contactNo_r" name="ContactNo" type="text" class="form-control" readonly>
                        </div>
                        <div class="col-4">
                            <label for="age_r" class="form-label">Age</label>
                            <input id="age_r" name="Age" type="text" class="form-control" readonly>
                        </div>
                    </div>

                    @* <div class="row">
                        <div class="col-12">
                            <label for="imageFile_r" class="form-label">Profile Image</label>
                            <input id="imageFile_r" name="imageFile" type="file" class="form-control" disabled>
                        </div>
                    </div> *@

                    <div class="row">
                        <div class="col-12">
                            <label for="imageFile_r" class="form-label">Profile Image</label>
                            <input id="imageFile_r" name="imageFile" type="file" class="form-control" onchange="previewImage(this)" hidden><br />
                            <!-- Image preview -->
                            <img id="imagePreview_r" src="#" alt="Image Preview" style="max-width: 100%; max-height: 150px; margin-top: 10px; display: none;">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>

<hr />

<h3 class="text-decoration-underline">@ViewData["title"]</h3>

<table class="table" id="emp-table">
    <thead>
        <tr>
            <th>Profile</th>
            <th>Employee Id</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Contact No</th>
            <th>Email Id</th>
            <th>Age</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @* Use AJAX for displaying data *@
    </tbody>
</table>

<script>
    // Retrieve data in tabular form
    $(document).ready(function () {
        debugger;

        get();
    });

    function get() {

        // Destroy the existing DataTable
        if ($.fn.DataTable.isDataTable('#emp-table')) {
            $('#emp-table').DataTable().destroy();
        }

        $.ajax({
            type: "Get",
            url: "/Employee/EmployeesList",
            success: function (data) {
                $('#emp-table').DataTable({
                    data: data,
                    columns: [
                        {
                            data: 'profileImage',
                            render: function (data, type, row) {
                                return '<img class="rounded-circle" src="/images/' + data + '" width="25" height="25" alt="Image"/>';
                            }
                        },
                        { data: 'id' },
                        { data: 'firstName' },
                        { data: 'lastName' },
                        { data: 'emailId' },
                        { data: 'contactNo' },
                        { data: 'age' },
                        {
                            data: null,
                            render: function (data, type, row) {
                                return '<button type="button" onclick=viewEmployee(' + row.id + ') class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewEmployeeModal">Details</button> | <button type="button" onclick=populateUpdateModal(' + row.id + ') class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#updateEmployeeModal">Edit</button> | <button type="button" onclick=deleteEmployee(' + row.id + ') class="btn btn-danger btn-sm">Delete</button>';
                            }
                        }
                    ]
                });
            }
        });

    }

    // Function for view employee by their ID
    function viewEmployee(employeeId) {
        debugger;
        $.ajax({
            type: "GET",
            url: "/Employee/GetEmployeeById/" + employeeId, // Update URL based on routing
            success: function (employee) {

                // Populate form fields with employee details
                $('#empId_r').val(employee.id);
                $('#firstName_r').val(employee.firstName);
                $('#lastName_r').val(employee.lastName);
                $('#emailId_r').val(employee.emailId);
                $('#contactNo_r').val(employee.contactNo);
                $('#age_r').val(employee.age);

                var imagePreview = employee.profileImage
                    ? '/images/' + employee.profileImage
                    : 'Upload Image';
                $('#imagePreview_r').attr('src', imagePreview).show();

            },
            error: function (error) {
                console.error("Error fetching employee details:", error);
            }
        });

    }

    // Function for save anew employee
    function saveEmployee() {

        var employeeData = {
            FirstName: $('#firstName').val(),
            LastName: $('#lastName').val(),
            EmailId: $('#emailId').val(),
            ContactNo: $('#contactNo').val(),
            Age: $('#age').val(),
        }

        debugger;

        var formData = new FormData();
        formData.append("model", JSON.stringify(employeeData));
        formData.append("file", $("#imageFile")[0].files[0]);

        debugger;

        $.ajax({
            type: "POST",
            url: "/Employee/Create",
            data: formData,
            contentType: false,
            processData: false,
            Cache: false,
            success: function (data) {
                console.log("Employee saved successfully!");
                $('#saveEmployeeModal').modal('hide');

                // Clear the form fields
                $('#firstName').val('');
                $('#lastName').val('');
                $('#emailId').val('');
                $('#contactNo').val('');
                $('#age').val('');
                $('#imageFile').val('');

                get();
            },
            error: function (error) {
                console.error("Error saving employee:", error);
            }
        });
    }

    // Function to populate form fields by ID for Update Data
    function populateUpdateModal(employeeId) {
        debugger;
        $.ajax({
            type: "GET",
            url: "/Employee/populateEditData/" + employeeId, // Update URL based on routing
            success: function (employee) {

                // Populate form fields with employee details
                $('#empId_u').val(employee.id);
                $('#firstName_u').val(employee.firstName);
                $('#lastName_u').val(employee.lastName);
                $('#emailId_u').val(employee.emailId);
                $('#contactNo_u').val(employee.contactNo);
                $('#age_u').val(employee.age);

                var imagePreview = employee.profileImage
                    ? '/images/' + employee.profileImage
                    : 'Upload Image';
                $('#imagePreview_u').attr('src', imagePreview).show();

            },
            error: function (error) {
                console.error("Error fetching employee details:", error);
            }
        });

    }


    function updateEmployee() {

        // Collect form field values into an object

        var employeeId = {
            Id: $('#empId_u').val()
        }

        debugger;

        var employeeData = {
            FirstName: $('#firstName_u').val(),
            LastName: $('#lastName_u').val(),
            EmailId: $('#emailId_u').val(),
            ContactNo: $('#contactNo_u').val(),
            Age: $('#age_u').val()
        };

        debugger;

        var formData = new FormData();
        formData.append("Id", employeeId.Id);
        formData.append("model", JSON.stringify(employeeData));
        formData.append("file", $("#imageFile_u")[0].files[0]);

        debugger;

        $.ajax({
            type: "POST",
            url: "/Employee/Edit",
            data: formData,
            contentType: false,
            processData: false,
            Cache: false,
            success: function (data) {
                alert("Employee updated successfully!");
                $('#updateEmployeeModal').modal('hide');

                get();
            },
            error: function (error) {
                console.error("Error updating employee:", error);
            },
        });
    }


    // Function for delete existing new employee
    function deleteEmployee(employeeId) {
        if (confirm("Are you sure you want to delete this employee?")) {
            $.ajax({
                type: "GET",
                url: "/Employee/Delete/" + employeeId,
                success: function (data) {
                    alert("Employee deleted successfully!");

                    get();
                },
                error: function (error) {
                    console.error("Error deleting employee:", error);
                }
            });
        }
    }

    function previewImage(input) {
        var file = input.files[0];

        if (file) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#imagePreview_u').attr('src', e.target.result).show();
            };

            reader.readAsDataURL(file);
        } else {
            // Clear the image preview if no file is selected
            $('#imagePreview_u').attr('src', '').hide();
        }
    }

</script>